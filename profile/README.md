# Система поддержки принятия решений для врачей-онкологов
## Документация проекта

### 1. Цели и предпосылки

#### 1.1 Текущий бизнес-процесс

- Не во всех регионах РФ отделения онкологии / гематологии проводят высокотехнологичное лечение.
- Пациентам приходится обращаться в центры/институты в крупных городах.
- Институты и клиники в крупных городах перегружены, так как им отправляют самые разные запросы со всех уголков страны.
- Иногда пациенты напрямую обращаются к врачам-онкологам для консультации.
- Для проведения онлайн-консультации между врачами и пациентами используются такие инструменты как электронная почта и телемедицина.
- Однако оба эти инструмента не приспособлены для проведения онлайн-консультаций и хранения и обработки данных пациентов.
- Кроме того, из-за высокой загруженности врачи в институтах/центрах могут вовремя не проанализировать критические случаи.

#### 1.2 Выявленные проблемы

- У врачей-онкологов нет удобного инструмента для проведения онлайн-консультаций.
- Врачам необходим инструмент для ускорения принятия решений, так как в такой сфере, как онкология, очень важно вовремя отследить изменения опухоли.
- Молодым врчам требуется много времени для анализа более 200 изображений.

#### 1.3 Цель и задачи

Цель – разработать инструмент для взаимодейтсвия врачей и пациентов, в который будут интегрированы системы классификации изображений (есть/нет опухоли) и сегментации опухолей.

Задачи:
- запустить MVP,
- отдать MVP на тестирования заказчикам,
- доработать MVP с учетом ввода новых видов опухолей.

#### 1.4 Бизнес-требования и ограничения

Использование ML позволит ускорить процесс принятия врачом решения.

##### Работаем с МРТ-снимками головного мозга

Бизнес-требования:
- снимки загружаются в трекер пациентом,
- создается тикет пациента на врача,
- использование ML ни в коем случае __не призвано заменить врача__,
- результаты работы ML моделей __не будут показываться пациентам__.

##### C4 Context Level

![C4 Context Level](https://github.com/bs-muu/.github/blob/main/images/ai-screen-it-C4_Context_-_For_Presentation.drawio.png)

##### Трекер пациентов

Бизнес-требования:
- удобство UI-UX для врача,
- система уведомлений,
- модель прав доступа RBAC,
- реакции +1 / -1 на коммент для фидбека модели,
- наличие вебхуков / API,
- внешний логин на базе OAuth2 / OpenID,
- свободная коммерческая лицензия,
- открытый исходный код.

Врач и пациент будут взамодействовать через трекер. Врач будет создавать для конкрентного пациента "проект", затем будет отправлять приглашение пациенту в этот проект. Пациент сможет выложить в проект свой МРТ-снимок, который автоматически будет проанализирован ML моделями.

### 2. Методология

#### 2.1 Постановка задачи CV

Решение задачи:
- __классификации__ изображений,
- семантической __сегментации__ для попиксельной обработки изображений.

Классификация изобажений необходима для:
- фильтрации нерелевантных изображений для обучения модели сегментации,
- выделения снимка, на который стоит обратить внимание в первую очередь.

Сегментация изображений необходима для:
- проверки и визуализации пациенту снимка с подозрением,
- оценки динамики изменения опухоли,
- ранжирования спорных снимков.

#### 2.2 Постановка задачи DE

1. Multimodal Data.

DICOM со снимками их параметрами, включая девайс и его параметры такие как модель и мощность сканера, данные векторов с мутациями, данные о выживаемости.

- 500+ векторов и данных о выживаемости.
- 9000+ снимков.


3. Domain Data.

- Подготовка данных врачами.
- Анонимизация.
- Организация разметки экспертами.


4. Interdisciplinary Teamwork.

В команде принимают участие архитекторы решений и ПО, продакт и аналитик мед.данных, инженер данных, инженеры компьютерного зрения, ну и конечно врачи-онкологи, -гематологи, -рентгенологи, генетики.


6. Dataset.
   
   Для первоначальных экспериментов и получения proof of concept использовался открытый [датасет](https://www.kaggle.com/datasets/mateuszbuda/lgg-mri-segmentation) с платформы Kaggle, представляющий из себя набор снимков МРТ, содержащих опухоли и соответствующие им сегментационные маски.

    Ввиду низкой точности работы моделей-сегментаторов, обученных на открытом датасете, для дальнейшей работы в проекте использовался собственный закрытый датасет, размеченный при участии врачей - участников команды.

    Всего было составлено два датасета:

     * Датасет для обучения модели-классификатора
       
         Содержит изображения с соответствующими им метками классов. Всего классов 3:
       
           1. with_tumor - релевантный снимок, на котором видна опухоль головного мозга
       
           2. without_tumor - релевантный снимок, на котором опухоль не видна
       
           3. trash - нерелевантный для обучения модели снимок (на снимке ничего не видно, виден только шум, либо на снимке отображена НЕ область головного мозга)

     * Датасет для обучения модели-сегментатора

          Состоит из изображений, содержащих опухоль головного мозга, и соответствующих сегментационных масок

   
7. Database.

    Для хранения данных в проекте используется СУБД PostgreSQL, входящая в состав ПО для аннотирования данных CVAT
   
8. Schema.
   
    Данные поставляются в проект в виде zip-архивов, содержащих снимки МРТ в специализированном формате DICOM. В дальнейшем снимки распаковываются и конвертируются в формат png.
   
    Разрешение снимков варьируется от 250x250 px до 725x725 px

   Средний размер одного снимка: 1MB


9. Data Service.

   Для хранения размеченных снимков и аннотаций в нужном для обучения моделей формате используется self-hosted хранилище MinIO сс поддержкой протокола S3.

Сейчас разрабатывается Интеграционный пайплайн между сырыми данными на S3, данными CVAT и системой обучения моделей, который будет автоматически сканировать MinIO / CVAT на наличие данных по текущим и новым видам опухолей, осуществляет ETL / ELT в / из MinIO, которые потом используются для дообучения моделей.

Это необходимо для масштабирования на другие виды опухолей и подготовки коробочного решения. Также это позволит внедрить модуль загрузки файлов Таск-трекера. Сейчас в прототипе ZIP-архивы с сырыми данными загружаются на сервер по протоколу FTP, после внедрения Интеграционного пайплайна это можно будет делать через Трекер что упростит трекинг новых сырых данных.

   
11. Data Benchmark.

1. Visualisation.
   
   Для визуализации аннотаций используется интерфейс CVAT
   
   ![image](https://github.com/bs-muu/.github/assets/38013055/fe8a1d01-fcc9-4206-811e-01e2ba559655)

   Предсказания моделей визуализируются средствами библиотеки OpenCV

   ![image](https://github.com/bs-muu/.github/assets/38013055/dfaae8e4-4ac2-4ec2-ac89-93a52737d930)

   ![image](https://github.com/bs-muu/.github/assets/38013055/c8ab944a-4d0c-421c-a06d-14399e45700b)

   Ошибки в предсказаниях моделей, для последующего анализа и возможного исправления неточностей в аннотациях, визуализируются средствами библиотеки OpenCV

   ![cn18007426_15_00140008](https://github.com/bs-muu/.github/assets/38013055/c7cb3281-781c-43c6-82b7-f95119eed82b)

##### Критерии

0. Междисциплинарная команда с взаимодополняющим опытом.
1. Определена задача, специфичная для предметной области. Актуальная и понятная
2. Анализ границ научной работы и прикладной.
3. Данные действительно представляют собой проблему: сложная структура, мультимодальные данные, разнородные данные, множество источников, грязные данные или немаркированные данные.
4. Решение предметной проблемы.
5. Анализ источников данных, структуры и требований к набору данных для задачи.
6. Собственный набор данных из разных источников.
7. Разработан прототип для хранения, обработки и представления данных.
8. Под задачу был составлен бенчмарк, протестированы модели открытого машинного обучения или алгоритмы анализа данных.
9. Простое решение для конечных пользователей по работе с данными.

#### 2.2 Этапы решения задачи

1. Анализ предметной области, проблем и решений с использованием данных предметной области.
2. Декомпозиция задачи по работе с данными в предметной области, определение требований к данным.
3. Подготовка наборов данных, определение качества данных и эталонных данных.
4. Прототипирование и внедрение сервисов хранения, доступа и обработки данных.
5. Работа в междисциплинарной команде с фидбеком врачей.
6. Внедрение прототипа.
7. Масштабирование.

### 3. Прототип

#### 3.1 Критерий успешности решения

Успешным прототип будет считаться после получения положительной обратной связи от врачей после первого тестирования.

#### 3.2 Архитектура решения

##### Activity Diagram

![Activity Diagram](https://github.com/bs-muu/.github/blob/main/images/ai-screen-it-Activity%20diagram.drawio.png)  

##### C4 Context Level

![C4 Context Diagraml](https://github.com/bs-muu/.github/blob/main/images/ai-screen-it-C4_Context_-_For_Presentation.drawio.png)

##### C4 Container Level

![C4 Container Diagram](https://github.com/bs-muu/.github/blob/main/images/ai-screen-it-C4%20Container.drawio.png)

#### 3.3 Безопасность данных

- Так как у нас ведется работа с персональными данными пациентов, мы понимаем важность зашиты персональных данных.
- Вся работа у нас ведется на нашем собственном сервере. Данные пациентов зашифрованы.

### 4. Команда проекта

#### 4.1 Менторы

| Имя Фамилия | Должность |
| ------------- | ------------- |
| Рамиль 3айнуллин  | Инициатор-куратор проекта |
| Дмитрий Головин  | Архитектор-разработчик ПО  |
| Эндже Валиахметова | Врач нейроонколог НМИЦ им. Бурденко |
| Людмила Ясько | Старший научный сотрудник лаборатории молекулярной биологии НМИЦ ДГОИ |

#### 4.2 Студенты 1 курса AI Talent Hub

| Имя Фамилия | Должность |
| ------------- | ------------- |
| Артем Даняев | ML Engineer |
| Михаил Бекусов | ML Engineer |
| Константин Калиновский | ML Engineer |
| Александр Лакиза | Product Owner |
| Сергей Китаев | Full-stack Engineer |
| Андрей Павлов | Data Engineer |

### 5. Полезные материалы

- [Презентация 18.12.2023 на проектном семинаре](https://docs.google.com/presentation/d/1jmd8ZPJN2W_otuVlJMtpkSThPnvUJVPi6uIuxa3TRTQ/edit?usp=sharing)
- [Презентация 20.01.2024 на демо-день AI Talent Hub](https://docs.google.com/presentation/d/1SEVVAZcO-8JxKyr8NNUuodzam3GrQbnGUFPHpfWr8wo/edit?usp=sharing)
- [Пример работы](https://github.com/bs-muu/.github/assets/115554194/b15063e3-66cc-46f6-ba52-5f91288ef43b)
